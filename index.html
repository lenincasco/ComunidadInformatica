<!DOCTYPE HTML>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<link rel="stylesheet" type="text/css" href="css/estilo.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="http://localhost:8080/socket.io/socket.io.js"></script>
<script>
// Almacenar nombre del usuario
var user
// Nos conectamos a nuestro servidor Nodejs
var socket = io.connect('http://localhost:8080')

// Cuando el documento este listo
$(function() {
	// Obtenemos el nom para el campo donde va el nombre (id="nom")
	var nombre = $('#nom')
	// Obtenemos el input mensaje que es el campo del mensaje (id="mensaje")
	var mensaje = $('#mensaje')
	// si ya se habia conectado y por alguna razon recargo la pagina volvemos a poner su usario
	if (localStorage.userName) {
		nombre.val(localStorage.userName)
		user = localStorage.userName
		socket.emit('nombre', user)
		nombre.attr('disabled', true)
		mensaje.focus()
	}

	// Cuando pierda el foco el campo nombre
	nombre.on('focusout', function() {
		// Validar si se ha escrito algo
		if ($(this).val() !== '') {
			// se desabilita el campo para no cambiar el nombre de suario
			$(this).attr('disabled', true)
			// Si se escribio
			// almacenamos localmente el nombre del usuario
			user = nombre.val()
			// Hacemos un llamado al servidor con la funcion 'nombre' y le pasamos el nombre
			socket.emit('nombre', user)
		}
	})

	// Cuando obtenga el enfoque el campo mensaje
	mensaje.on('focus', function() {
		// Comprobamos si ya tenemos un nombre en el campo
		if(!nombre.val()) {
			nombre.focus()
		}
	})

	//Cuando se da enter la caja de mensaje
	$('#mensaje').on('keyup', function(e) {
		if(e.which == 13) {
			e.preventDefault()
			// Si el campo nombre no esta vacio
			if (nombre.val()) {
				// Enviamos el mensaje al servidor por la funcion 'mensaje'
				socket.emit('mensaje', mensaje.val(), user)
				mensaje.val('')
				if (!localStorage.userName) {
					localStorage.userName = user
				}
			}
		}
	})

	//Cuando se de el evento mensaje
	socket.on('mensaje', function(mensaje, usuario) {
		$('#messages').prepend('\
			<li>\
				<div class="avatar">\
					<a href="http://twitter.com/' + usuario + '" title="&#64;' + usuario + '" target="_blank"><img src="https://api.twitter.com/1/users/profile_image?screen_name=' + usuario + '&size=normal" alt="&#64;' + usuario + '" height="38" width="38"></a>\
				</div>\
				<div class="text">\
					<a href="http://twitter.com/' + usuario + '" title="&#64;' + usuario + '" target="_blank">&#64;' + usuario + '</a>\
					<p>' + replaceEmoticon(mensaje) + '</p>\
				</div>\
			</li>')
	})

	//Este evento hace lo mismo que la funcion mensaje pero, se da cuando se conecta un usuario nuevo
	socket.on('msjCon', function(mensaje, usuario) {
		$('#messages').prepend('\
			<li>\
				<div class="avatar">\
					<a href="http://twitter.com/' + usuario + '" title="&#64;' + usuario + '" target="_blank"><img src="https://api.twitter.com/1/users/profile_image?screen_name=' + usuario + '&size=normal" alt="&#64;' + usuario + '" height="38" width="38"></a>\
				</div>\
				<div class="text">\
					<a href="http://twitter.com/' + usuario + '" title="&#64;' + usuario + '" target="_blank">&#64;' + usuario + '</a>\
					<p>' + replaceEmoticon(mensaje) + '</p>\
				</div>\
			</li>')
	})

	socket.on('actualizarCantidad', function(cantidad) {
		$('#cantU').val('')
		$('#cantU').text(cantidad)
	})
})

replaceEmoticon = function(mensaje) {
	return mensaje.replace(/(:\)|:\(|:p|:P|:D|:o|:O|;\)|8\)|B\||>:\(|:\/|:'\(|3:\)|o:\)|O:\)|:\*|<3|\^_\^|-_-|o.O|>.<|:v|:V|:3|\(y\)|\(Y\))/g, '<span title="$1" class="emoticon"></span>')
}
</script>
</head>
<body>
	<div id="chat">
		<p id="count">Usuarios Conectados: <strong id="cantU"></strong></p>
		<form id="formulario" action="">
			<input id="nom" type="text" placeholder="Nombre de usario, por ahora preferiblemente de twitter" autofocus>
			<textarea id="mensaje" placeholder="Envia tu comentario"></textarea>
		</form>
		<ul id="messages"></ul>
	</div>
</body>
</html>